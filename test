<!-- Chosen Palette: "Policy Trust" - Warm Off-White Background (#F9FAFB), Deep Teal Primary (#0F766E), Soft Slate Text (#374151), Muted Gold Accent (#D97706) for highlights. -->

<!-- Application Structure Plan:
    1. **Dashboard Layout**: A persistent sidebar navigation (mobile responsive) with a main content area to allow non-linear exploration of the policy reforms.
    2. **Executive Summary (Hero)**: Immediate visual impact with "Big Number" cards highlighting the budget increase and key max subsidy amounts.
    3. **Interactive Simulator ("Am I Eligible?")**: A logical flow to explain the "Switching Bonus" by asking user inputs (Vehicle age, Fuel type) rather than just listing rules.
    4. **Comparative Analysis (2025 vs 2026)**: A split-view section allowing users to toggle between "Old" and "New" policy details to understand the structural shift.
    5. **Sector Deep Dive (Commercial & Safety)**: Dedicated sections for B2B/Commercial users and the new Safety mandates, using charts to visualize the massive support for heavy trucks/buses.
    6. **Gemini AI Integration**: Floating chatbot for Q&A and contextual analysis within the simulator.
    Rationale: This structure breaks down complex policy text into actionable tools (simulator) and visual comparisons, catering to both casual readers and strategic planners.
-->

<!-- Visualization & Content Choices:
    1. **Report Info**: 2026 Budget Increase (+20%).
       **Goal**: Inform.
       **Viz**: Simple Bar Chart (Chart.js) comparing 2025 vs 2026 Total Budget.
       **Interaction**: Tooltip showing exact KRW amounts.
    2. **Report Info**: Subsidy Cap Changes (National + Bonus).
       **Goal**: Compare.
       **Viz**: Stacked Bar Chart (Chart.js) showing Base Subsidy vs. Switching Bonus impact.
       **Interaction**: Legend toggle.
    3. **Report Info**: Commercial Vehicle Support (Bus/Truck).
       **Goal**: Relationships/Scale.
       **Viz**: Horizontal Bar Chart (Chart.js) emphasizing the high support caps (30M/60M) vs Passenger cars.
       **Interaction**: Hover details.
    4. **Report Info**: Switching Bonus Eligibility.
       **Goal**: Change/Engage.
       **Viz**: Interactive HTML Form/Logic (No Chart). Users select status, JS updates the result box.
       **Justification**: Direct user engagement is better than a static list of rules.
    5. **Report Info**: Safety Requirements.
       **Goal**: Organize.
       **Viz**: Interactive Cards (HTML/CSS) that flip or expand to show details on "Battery Passport" and "Insurance".
-->

<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 EV Subsidy Reform Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom Utilities */
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #F9FAFB; color: #374151; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 350px; /* Base height */
            margin: 0 auto;
        }
        @media (max-width: 640px) {
            .chart-container { height: 250px; }
        }
        .nav-item.active {
            background-color: #0F766E;
            color: white;
            font-weight: 600;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .transition-all-300 { transition: all 0.3s ease; }
        
        /* Chat Widget Styles */
        .chat-widget {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 50;
        }
        .chat-window {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #E5E7EB;
            display: flex;
            flex-direction: column;
            z-index: 50;
            transform-origin: bottom right;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .chat-window.hidden {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
            pointer-events: none;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        .message-user {
            background-color: #0F766E;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .message-ai {
            background-color: #F3F4F6;
            color: #1F2937;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">

    <!-- Sidebar Navigation -->
    <nav class="bg-white w-full md:w-64 border-r border-gray-200 flex-shrink-0 flex flex-col justify-between">
        <div>
            <div class="p-6 border-b border-gray-100">
                <h1 class="text-xl font-bold text-teal-800 tracking-tight">EV Policy <br/><span class="text-amber-600">2026 Reform</span></h1>
                <p class="text-xs text-gray-500 mt-2">Strategic Report Dashboard</p>
            </div>
            <ul class="flex flex-col p-4 space-y-2">
                <li>
                    <button onclick="navigate('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-4 py-3 rounded-lg text-sm transition-all-300 hover:bg-teal-50 active">
                        <i class="fas fa-chart-pie w-6"></i> Executive Summary
                    </button>
                </li>
                <li>
                    <button onclick="navigate('comparison')" id="nav-comparison" class="nav-item w-full text-left px-4 py-3 rounded-lg text-sm transition-all-300 hover:bg-teal-50">
                        <i class="fas fa-balance-scale w-6"></i> 2025 vs 2026
                    </button>
                </li>
                <li>
                    <button onclick="navigate('simulator')" id="nav-simulator" class="nav-item w-full text-left px-4 py-3 rounded-lg text-sm transition-all-300 hover:bg-teal-50">
                        <i class="fas fa-calculator w-6"></i> Bonus Simulator
                    </button>
                </li>
                <li>
                    <button onclick="navigate('safety')" id="nav-safety" class="nav-item w-full text-left px-4 py-3 rounded-lg text-sm transition-all-300 hover:bg-teal-50">
                        <i class="fas fa-shield-alt w-6"></i> Safety & Comm.
                    </button>
                </li>
            </ul>
        </div>
        <div class="p-6 bg-gray-50 text-xs text-gray-400">
            <p>Source: Ministry of Environment (Jan 30, 2026)</p>
            <p class="mt-2 text-teal-600 font-semibold flex items-center gap-1"><i class="fas fa-sparkles"></i> Powered by Gemini</p>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 relative">
        
        <!-- SECTION: EXECUTIVE SUMMARY (Dashboard) -->
        <section id="dashboard" class="section-view space-y-8 animate-fade-in">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900">Executive Summary</h2>
                    <p class="text-lg text-gray-600 mt-2 max-w-3xl">
                        The 2026 reform marks a paradigm shift to <strong>"replacement & safety"</strong>.
                    </p>
                </div>
                <button onclick="toggleChat('Tell me the key highlights of the 2026 EV Policy reform in 3 bullet points.')" class="bg-gradient-to-r from-teal-600 to-teal-500 hover:from-teal-700 hover:to-teal-600 text-white px-4 py-2 rounded-lg shadow-md text-sm font-medium transition-all flex items-center gap-2">
                    <i class="fas fa-sparkles"></i> AI Summary
                </button>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl border border-gray-200 card-hover transition-all-300">
                    <div class="text-sm font-medium text-gray-500 uppercase">Total Budget</div>
                    <div class="mt-2 text-3xl font-bold text-teal-700">936 Billion KRW</div>
                    <div class="mt-1 text-sm text-green-600 font-semibold">‚ñ≤ 20% Increase</div>
                    <p class="mt-4 text-xs text-gray-400">Expanded to support infrastructure & commercial fleets.</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-200 card-hover transition-all-300">
                    <div class="text-sm font-medium text-gray-500 uppercase">Max Passenger Subsidy</div>
                    <div class="mt-2 text-3xl font-bold text-amber-600">6.8 Million KRW</div>
                    <div class="mt-1 text-sm text-gray-600">Base + New Bonus</div>
                    <p class="mt-4 text-xs text-gray-400">Includes the new 1M KRW Switching Bonus.</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-200 card-hover transition-all-300">
                    <div class="text-sm font-medium text-gray-500 uppercase">Heavy Truck Support</div>
                    <div class="mt-2 text-3xl font-bold text-indigo-700">60 Million KRW</div>
                    <div class="mt-1 text-sm text-indigo-500">Max Cap</div>
                    <p class="mt-4 text-xs text-gray-400">Targeting high-emission logistics vehicles.</p>
                </div>
            </div>

            <!-- Chart: Budget Overview -->
            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Budget Expansion Strategy</h3>
                <p class="text-sm text-gray-500 mb-6">Comparing the fiscal commitment to the EV transition between 2025 and 2026.</p>
                <div class="chart-container">
                    <canvas id="budgetChart"></canvas>
                </div>
            </div>
            
            <div class="bg-teal-50 border border-teal-100 rounded-lg p-6">
                 <h3 class="text-teal-900 font-bold mb-2">Strategic Insight</h3>
                 <p class="text-teal-800 text-sm leading-relaxed">
                     The introduction of the <strong>"Switching Bonus"</strong> creates a prime opportunity to target existing ICE owners (replacement demand) rather than just early adopters. This is critical to revitalizing sales volume in Q1 2026.
                 </p>
            </div>
        </section>


        <!-- SECTION: COMPARISON -->
        <section id="comparison" class="section-view hidden space-y-8 animate-fade-in">
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900">2025 vs 2026 Comparison</h2>
                <p class="text-gray-600 mt-2">Analyzing the structural changes in subsidy policy to identify key impacts.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Table Column -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-700 font-semibold border-b">
                            <tr>
                                <th class="p-4">Category</th>
                                <th class="p-4 text-gray-500">2025 Policy</th>
                                <th class="p-4 text-teal-700">2026 Reform</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-medium">Subsidy Cap</td>
                                <td class="p-4 text-gray-500">Max 5.8M (Decreasing)</td>
                                <td class="p-4 text-teal-700 font-bold">Max 6.8M (Maintained + Bonus)</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-medium">New Incentives</td>
                                <td class="p-4 text-gray-500">None</td>
                                <td class="p-4 text-teal-700 font-bold">Switching Bonus (1M)</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-medium">Battery Standards</td>
                                <td class="p-4 text-gray-500">Energy Density Focus</td>
                                <td class="p-4 text-teal-700 font-bold">Safety + Recycling</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-medium">Key Targets</td>
                                <td class="p-4 text-gray-500">Passenger / Small Cargo</td>
                                <td class="p-4 text-teal-700 font-bold">School Buses / Heavy Trucks</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Visualization Column -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-center">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Effective Subsidy Benefit</h3>
                    <p class="text-xs text-gray-500 mb-4">The graph below illustrates how the Switching Bonus effectively reverses the trend of decreasing subsidies.</p>
                    <div class="chart-container">
                        <canvas id="subsidyComparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                 <div class="p-6 bg-white border-l-4 border-amber-500 rounded-r-xl shadow-sm">
                     <h4 class="font-bold text-gray-900">Opportunity: Replacement Demand</h4>
                     <p class="text-sm text-gray-600 mt-2">The 1M KRW bonus specifically targets 3+ year ICE owners, unlocking a massive segment of the market that was previously hesitant.</p>
                 </div>
                 <div class="p-6 bg-white border-l-4 border-red-500 rounded-r-xl shadow-sm">
                     <h4 class="font-bold text-gray-900">Risk: Sunset Clause</h4>
                     <p class="text-sm text-gray-600 mt-2">Tax benefits (Acquisition tax reduction) are under review for a sunset clause, creating urgency for buyers to purchase in 2026.</p>
                 </div>
            </div>
        </section>


        <!-- SECTION: SIMULATOR -->
        <section id="simulator" class="section-view hidden space-y-8 animate-fade-in">
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900">Switching Bonus Simulator</h2>
                <p class="text-gray-600 mt-2">Determine eligibility for the new <strong>KRW 1,000,000</strong> incentive.</p>
            </div>

            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Input Panel -->
                <div class="w-full lg:w-1/2 bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-bold text-teal-800 mb-6 border-b pb-2">Step 1: Vehicle Status</h3>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Current Vehicle Type</label>
                            <select id="sim-current-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition">
                                <option value="ice">Internal Combustion Engine (Gas/Diesel)</option>
                                <option value="ev">Electric Vehicle</option>
                                <option value="none">I don't own a car</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ownership Duration</label>
                            <select id="sim-duration" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition">
                                <option value="under3">Less than 3 years</option>
                                <option value="over3">3 years or more</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">New Purchase Plan</label>
                            <select id="sim-new-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition">
                                <option value="ev_pass">New Electric Vehicle (Passenger)</option>
                                <option value="hybrid">New Hybrid Vehicle</option>
                                <option value="used_ev">Used Electric Vehicle</option>
                            </select>
                        </div>

                        <button onclick="calculateBonus()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform active:scale-95">
                            Check Eligibility
                        </button>
                    </div>
                </div>

                <!-- Result Panel -->
                <div class="w-full lg:w-1/2 flex flex-col items-center justify-center p-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 relative" id="sim-result-container">
                    <div class="text-center">
                        <div class="text-6xl mb-4">üöó</div>
                        <h3 class="text-xl font-medium text-gray-500">Enter your details to see if you qualify.</h3>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                <h4 class="font-bold text-blue-800 text-sm uppercase mb-2">Key Rule Reminder</h4>
                <p class="text-blue-700 text-sm">
                    The bonus requires scrapping or selling (export included) your old vehicle within <strong>6 months</strong> of registering the new EV. Family transfers or "pro-forma" transactions are strictly excluded.
                </p>
            </div>
        </section>


        <!-- SECTION: SAFETY & COMMERCIAL -->
        <section id="safety" class="section-view hidden space-y-8 animate-fade-in">
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900">Safety & Commercial Expansion</h2>
                <p class="text-gray-600 mt-2">New pillars of the 2026 policy: rigorous safety standards and heavy-duty logistics support.</p>
            </div>

            <!-- Safety Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Safety Card 1 -->
                <div class="bg-white p-6 rounded-xl border-l-4 border-red-500 shadow-sm">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Battery Passport</h3>
                            <p class="text-xs font-semibold text-red-500 uppercase mt-1">Mandatory Disclosure</p>
                        </div>
                        <span class="text-2xl">üîã</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-4 leading-relaxed">
                        Manufacturers must disclose Manufacturer, Voltage, and Capacity details. This aims to resolve consumer anxiety regarding EV fires. Transparency is now a prerequisite for subsidies.
                    </p>
                </div>
                <!-- Safety Card 2 -->
                <div class="bg-white p-6 rounded-xl border-l-4 border-blue-500 shadow-sm">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Responsibility Insurance</h3>
                            <p class="text-xs font-semibold text-blue-500 uppercase mt-1">Zero-Emission Safety</p>
                        </div>
                        <span class="text-2xl">üõ°Ô∏è</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-4 leading-relaxed">
                        Subsidy eligibility is strictly linked to the manufacturer's subscription to "Zero-Emission Vehicle Safety Responsibility Insurance." <strong>No Insurance = No Subsidy.</strong>
                    </p>
                </div>
            </div>

            <!-- Commercial Chart Section -->
            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                <div class="flex flex-col md:flex-row justify-between items-end mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Commercial Sector Support Caps</h3>
                        <p class="text-sm text-gray-500 mt-1">Significantly higher subsidies for high-emission heavy vehicles.</p>
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="commercialChart"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-3 rounded text-sm text-gray-600">
                        <strong>School Buses:</strong> Up to 30M KRW. Targeting models like Hyundai Staria / Kia Carnival to protect children's health.
                    </div>
                    <div class="bg-gray-50 p-3 rounded text-sm text-gray-600">
                        <strong>Heavy Trucks:</strong> Up to 60M KRW. Shifting focus from 1-ton trucks to medium/large logistics fleets.
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Gemini AI Chat Widget -->
    <div class="chat-widget">
        <!-- Chat Window -->
        <div id="ai-chat-window" class="chat-window hidden">
            <!-- Header -->
            <div class="bg-teal-700 text-white p-4 rounded-t-2xl flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-robot"></i>
                    <span class="font-bold">AI Policy Assistant</span>
                </div>
                <button onclick="toggleChat()" class="text-teal-200 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Messages Area -->
            <div id="chat-messages" class="chat-messages">
                <div class="message-bubble message-ai">
                    Hello! I'm your 2026 EV Policy Expert. Ask me anything about subsidies, the switching bonus, or safety requirements.
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="p-3 bg-gray-50 border-t border-gray-200 rounded-b-2xl">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Ask about the policy..." 
                           class="flex-1 p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
                           onkeypress="handleEnter(event)">
                    <button onclick="sendUserMessage()" class="bg-teal-600 hover:bg-teal-700 text-white p-2 rounded-lg w-10 h-10 flex items-center justify-center transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="text-[10px] text-gray-400 mt-1 text-center">AI can make mistakes. Check important info.</div>
            </div>
        </div>

        <!-- Chat Toggle Button -->
        <button onclick="toggleChat()" class="bg-teal-600 hover:bg-teal-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl transition-transform hover:scale-105 active:scale-95">
            <i class="fas fa-comment-dots"></i>
        </button>
    </div>


    <script>
        // --- Gemini AI Configuration ---
        const apiKey = ""; // Set by environment
        const systemPrompt = `You are an expert consultant on the 2026 South Korea EV Subsidy Reform. 
        Context:
        - Budget: 936 Billion KRW (+20% YoY).
        - Switching Bonus: 1 Million KRW for owners of 3+ year old Internal Combustion Engine (ICE) vehicles who switch to a new EV. (Hybrids excluded, Used EVs excluded).
        - Passenger EV Subsidy Cap: Max 6.8 Million KRW (Base 5.8M + 1M Bonus).
        - Commercial: Heavy Trucks up to 60M KRW, School Buses up to 30M KRW.
        - Safety: "Battery Passport" (Info disclosure) and "Responsibility Insurance" are now mandatory for full subsidy.
        - Tone: Professional, concise, and helpful. 
        - Language: Respond in the same language as the user's question (English or Korean).
        - If the user asks about the "Simulator Result", explain WHY they are eligible or not based on the provided JSON data.`;

        // --- Chat Logic ---
        const chatWindow = document.getElementById('ai-chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        let isChatOpen = false;

        function toggleChat(initialQuery = null) {
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                chatWindow.classList.remove('hidden');
                setTimeout(() => {
                    chatWindow.style.opacity = '1';
                    chatWindow.style.transform = 'scale(1) translateY(0)';
                }, 10);
                if (initialQuery) {
                    chatInput.value = initialQuery;
                    sendUserMessage();
                }
            } else {
                chatWindow.style.opacity = '0';
                chatWindow.style.transform = 'scale(0.9) translateY(20px)';
                setTimeout(() => chatWindow.classList.add('hidden'), 300);
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendUserMessage();
        }

        async function sendUserMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            // Add User Message
            appendMessage('user', text);
            chatInput.value = '';

            // Add Loading Indicator
            const loadingId = appendLoading();

            try {
                // Prepare API Call
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                const data = await response.json();
                
                // Remove Loading
                document.getElementById(loadingId).remove();

                if (data.candidates && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    appendMessage('ai', aiText);
                } else {
                    appendMessage('ai', "Sorry, I couldn't process that request right now.");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                document.getElementById(loadingId).remove();
                appendMessage('ai', "Error connecting to AI service. Please try again later.");
            }
        }

        function appendMessage(sender, text) {
            const div = document.createElement('div');
            div.className = `message-bubble ${sender === 'user' ? 'message-user' : 'message-ai'} animate-fade-in`;
            // Simple markdown-to-html for bolding
            div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); 
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message-bubble message-ai flex gap-1 items-center p-4';
            div.innerHTML = `
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        // --- Existing App Logic (with Gemini integration points) ---
        
        const state = { currentView: 'dashboard' };

        function navigate(viewId) {
            state.currentView = viewId;
            document.querySelectorAll('.section-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'bg-teal-700', 'text-white'));
            document.getElementById(`nav-${viewId}`).classList.add('active');
            
            if (viewId === 'dashboard' && budgetChart) budgetChart.resize();
            if (viewId === 'comparison' && subsidyComparisonChart) subsidyComparisonChart.resize();
            if (viewId === 'safety' && commercialChart) commercialChart.resize();
        }

        // --- Simulator Logic with AI Hook ---
        function calculateBonus() {
            const currentType = document.getElementById('sim-current-type').value;
            const duration = document.getElementById('sim-duration').value;
            const newType = document.getElementById('sim-new-type').value;
            const resultContainer = document.getElementById('sim-result-container');

            let eligible = false;
            let message, subMessage, icon, colorClass;

            if (currentType === 'ice' && duration === 'over3' && newType === 'ev_pass') {
                eligible = true;
                message = "Congratulations! You Qualify.";
                subMessage = "You are eligible for the <strong class='text-teal-700'>+1,000,000 KRW</strong> Switching Bonus.";
                icon = "üéâ";
                colorClass = "bg-green-50 border-green-200 text-green-800";
            } else {
                eligible = false;
                icon = "‚ö†Ô∏è";
                colorClass = "bg-gray-100 border-gray-300 text-gray-800";
                
                if (currentType !== 'ice') {
                    message = "Not Eligible";
                    subMessage = "Bonus is only for Internal Combustion Engine (ICE) owners.";
                } else if (duration !== 'over3') {
                    message = "Not Eligible";
                    subMessage = "Must have owned the ICE vehicle for at least 3 years.";
                } else if (newType === 'hybrid') {
                    message = "Not Eligible";
                    subMessage = "Hybrids are excluded from the Switching Bonus.";
                } else if (newType === 'used_ev') {
                    message = "Not Eligible";
                    subMessage = "Bonus applies to New EV purchases only.";
                }
            }

            // Construct the Explain Prompt
            const userScenario = `User Scenario: Current Car=${currentType}, Ownership=${duration}, New Car=${newType}. Result=${eligible ? 'Eligible' : 'Not Eligible'}.`;

            resultContainer.className = `w-full lg:w-1/2 flex flex-col items-center justify-center p-8 rounded-xl border ${colorClass} transition-all duration-500 animate-fade-in`;
            resultContainer.innerHTML = `
                <div class="text-center w-full">
                    <div class="text-6xl mb-4">${icon}</div>
                    <h3 class="text-2xl font-bold mb-2">${message}</h3>
                    <p class="text-sm leading-relaxed mb-6">${subMessage}</p>
                    
                    <button onclick="toggleChat('Please explain specifically why my result is: ${eligible ? 'Eligible' : 'Not Eligible'} based on: ${userScenario}. Give me advice.')" 
                            class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-sparkles text-amber-500"></i> Ask AI for Details
                    </button>
                </div>
            `;
        }

        // --- Charts Implementation (Same as before) ---
        let budgetChart, subsidyComparisonChart, commercialChart;

        function initCharts() {
            // Budget Chart
            const ctx1 = document.getElementById('budgetChart').getContext('2d');
            budgetChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['2025 Budget', '2026 Budget'],
                    datasets: [{
                        label: 'Budget (Billion KRW)',
                        data: [780, 936],
                        backgroundColor: ['#E5E7EB', '#0F766E'],
                        borderRadius: 6,
                        barThickness: 50
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
            });

            // Subsidy Chart
            const ctx2 = document.getElementById('subsidyComparisonChart').getContext('2d');
            subsidyComparisonChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['2025 Max', '2026 Max'],
                    datasets: [
                        { label: 'Base Subsidy', data: [5.8, 5.8], backgroundColor: '#9CA3AF', stack: 'Stack 0' },
                        { label: 'Switching Bonus', data: [0, 1.0], backgroundColor: '#D97706', stack: 'Stack 0' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true }, tooltip: { mode: 'index', intersect: false } }, scales: { y: { stacked: true, beginAtZero: true }, x: { stacked: true, grid: { display: false } } } }
            });

            // Commercial Chart
            const ctx3 = document.getElementById('commercialChart').getContext('2d');
            commercialChart = new Chart(ctx3, {
                type: 'bar',
                indexAxis: 'y',
                data: {
                    labels: ['Passenger EV', 'School Bus (EV)', 'Heavy Truck (Large)'],
                    datasets: [{
                        label: 'Max Subsidy (Million KRW)',
                        data: [6.8, 30, 60],
                        backgroundColor: ['#9CA3AF', '#0F766E', '#1E3A8A'],
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: '#F3F4F6' } }, y: { grid: { display: false } } } }
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            initCharts();
            document.getElementById('nav-dashboard').classList.add('active');
        });
    </script>
</body>
</html>
